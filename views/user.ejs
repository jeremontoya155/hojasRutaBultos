<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Hojas de Ruta</title>
    <link rel="stylesheet" href="/css/user.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <h2>Hojas de Ruta Asignadas a Sucursal <%= userSucursal %></h2>

    <h3>Resumen de Tipos de Códigos</h3>
    <ul>
        <% if (Object.keys(summaryByType).length > 0) { %>
            <% for (let [tipo, cantidad] of Object.entries(summaryByType)) { %>
                <li><%= tipo %>: <%= cantidad %></li>
            <% } %>
        <% } else { %>
            <li>No hay datos de tipos de códigos disponibles.</li>
        <% } %>
    </ul>

    <div>
        <input type="text" id="dateFilter" placeholder="Filtrar por intervalo de fechas..." />
    </div>

    <table border="1" id="routeTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Fecha de Creación</th>
                <th>Sucursal</th>
                <th>Situación</th> <!-- Ahora mostramos la situación de la sucursal -->
                <th>Fecha de Recepción</th>
                <th>Acciones</th>
                <th>Marcar Recibido</th>
            </tr>
        </thead>
        <tbody>
            <% routeSheets.forEach(sheet => { %>
                <tr>
                    <td><%= sheet.id %></td>
                    <td class="creation-date-cell"><%= new Date(sheet.created_at).toLocaleDateString('es-ES') %></td>
                    <td><%= sheet.sucursal %></td>
                    <td><%= sheet.situacion %></td> <!-- Mostramos la situación específica de la sucursal -->
                    <td>
                        <% if (sheet.fecha_entregado) { %>
                            <%= new Date(sheet.fecha_entregado).toLocaleDateString('es-ES') %>
                        <% } else { %>
                            <span>-</span>
                        <% } %>
                    </td>
                    <td>
                        <a href="/my-routes/view-route/<%= sheet.id %>">Ver Detalles</a>
                    </td>
                    <td>
                        <% if (sheet.situacion !== 'Recibido Sucursal') { %>
                            <input type="checkbox" onchange="marcarRecibido('<%= sheet.id %>', '<%= sheet.sucursal %>')">
                        <% } else { %>
                            <span>Recibido</span>
                        <% } %>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        flatpickr("#dateFilter", {
            mode: "range",
            dateFormat: "d/m/Y",
            onChange: function(selectedDates) {
                if (selectedDates.length === 2) {
                    filterByDateRange(selectedDates);
                }
            }
        });

        function filterByDateRange(dates) {
            const startDate = dates[0];
            const endDate = dates[1];
            const rows = document.querySelectorAll('#routeTable tbody tr');

            rows.forEach(row => {
                const dateCell = row.querySelector('.creation-date-cell');
                if (dateCell) {
                    const [day, month, year] = dateCell.textContent.split('/');
                    const rowDate = new Date(`${year}-${month}-${day}`);

                    if (rowDate >= startDate && rowDate <= endDate) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                }
            });
        }

        function marcarRecibido(routeSheetId, sucursalId) {
            fetch(`/my-routes/mark-received/${routeSheetId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ sucursalId }) // Enviamos el ID de la sucursal
            }).then(response => {
                if (response.ok) {
                    alert('Sucursal marcada como recibida');
                    location.reload(); // Recargar para reflejar el cambio
                } else {
                    alert('Error al marcar como recibida');
                }
            });
        }
    </script>
</body>
</html>
